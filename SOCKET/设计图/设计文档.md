# 通讯软件仿写练习



## 目的

本软件项目，目的为 学习并且练习 以下内容：

- WIN下QT的练习和应用
- 软件设计和实现流程
- SOCKET网络应用
- 面向对象设计模式和流程
- Linux （服务器端）的熟悉和初步应用   // 最终还是用了 windows 服务器
- 数据库的学习和初步应用



## 功能和界面

本软件是仿写类似 QQ 的IM软件，分为客户端和服务器端两大部分



### 客户端

------

以下内容为客户端内容，基本界面分为三大类： 登陆界面，主界面，聊天界面

#### 登陆界面

------



![image-20191106204748748](C:\Users\yan\AppData\Roaming\Typora\typora-user-images\image-20191106204748748.png)

- 记住密码功能
- 记录使用过的账号的功能
- 登陆加密过程
- 找回密码（网页端，暂时没做）
- 注册账号（网页端/窗口界面 未定）
- 窗口大小固定
- 登陆状态选择



#### 主界面

--------



![image-20191106205103250](C:\Users\yan\AppData\Roaming\Typora\typora-user-images\image-20191106205103250.png)

- 登陆判定（基于网络连接判定/呼吸判定 未定）
- 主界面拉伸设置（最大宽度600）
- 头像生成（底色+白字）
- 状态设置
- 昵称及签名设置（最长限定）
- 好友列表自定义分类功能
- 拉黑功能
- 选中效果及双击沟通判定
- 群聊天功能（无管理员模式）
- 最近谈话记录功能



#### 聊天界面

----



![image-20191106205748195](C:\Users\yan\AppData\Roaming\Typora\typora-user-images\image-20191106205748195.png)

- 缩放功能暂时不做，固定窗口大小
- 切换框点击切换聊天对象功能
- 聊天记录功能（加密存储在本地一部分）
- 上传和发送文件功能



## 软件设计思路

---

本软件尝试使用面向对象设计，将 本地用户抽象为一个具有唯一 U_ID 的对象。

发送带有 状态的 登陆数据包，并且通过验证之后，服务端分配监听进程，循环监听 （在线/消息/及个人设置更改/建立或退出聊天组）- > 抽象为一个监听函数；监听到消息后，进行判定类别，进行 消息文件转发/更新数据库/给讨论组分配资源操作。



本地客户端：

- 登陆前，账号记住和密码记住功能（ cookie ，时效性，失败一次性）
- 网络连接/在线判定消息发送
- 聊天记录本地归档和存储
- 自定义头像（上传）

类的初步思路：

```c++

class User
{
    public:
        void Change_Name(const string&);
        void Change_Signa(const string&);
        void Change_Stat(const Stat);
        void Send_message_to_friend(int UID,const string &MESSAGE,int Receive_ID);
        void Send_message_to_group(int UID,const string &MESSAGE,int Group_ID);
        void Creat_Group(int UID,list<int> Users);
    
    	void Custom_frined(const string& name);
    	void Custom_frined(const string& name,list<int> UID);
        void Blacklist(list<int> UID);
        
        void Listen();// 监听程序，包括了 消息监听，在线判断，好友/组信息更改内容
 
    
    private:
	    int UID;
    	enum Stat{ ONLINE,OFFLINE,ClOAK};
    	string USER_NAME;
    	string USER_SIGNA; 
        
        Class Friend_list;
        Class Group_list;
        Class Recent_Contacts;
}
```



## 服务端功能及思路

---



服务端的功能分为三个大块：

- 数据库类：数据校验功能（登陆），数据更改函数（改个人资料&密码），数据插入功能（聊天记录存储，账号注册），数据查找（添加好友）
- 操作日治及错误日治：记录服务器操作（时间，操作），输入错误日志
- 通讯功能类： 转发推送消息（在线及离线判断，并且推送消息缓存防止丢失||存在某个“待推送表”里面），登陆校验，发送文件/图片，
- #额外增加错误监听功能，每分钟服务端会发送消息到监听函数，以证明正常运行。如果服务端停止，则发送邮件到相应的邮箱 

### 数据库设计

----

1. USER 表 ：  存储用户资料 ID - 昵称 - 密码 - 签名 - 好友ID队列

2. MESSAGE 表：  存储聊天消息  SENT_TIME,SENT_ID, REC_ID, MES,  

3. TO_BE_SENT 表： 待发送消息，  和MESS表一致，但是发送一条会清理一条

   

### 数据库类

---

数据库类功能：

1.注册功能，在USER表中新建内容

2.查找功能，好友查询

3.修改功能，修改某项资料（签名，密码）

4.聊天记录导出功能

5.插入功能，插入聊天记录

//以下为调试类功能：

6.返回错误信息

7.返回查询结果

```c++
#define MYSQL_NAME root
#deine MYSQL_PASSWORD 112508

void Connect_database(MYSQL&); //初始化MYSQL使用

class IM_MYSQL
{
    friend void Connect_database(MYSQL&);
    
    public:
    
    private:
    MYSQL SQL;    //3张表格
}
```



## 客户端功能及设计

-------

1.私有成员为： 个人信息   好友列表   服务器SOCKET

2.构造：使用一个 服务器SOCKET + 登陆信息结构体初始化（包括个人USER信息 和 和好  友列表，以及离线消息三个内容

3.功能：

​	3.1. 处理一个聊天信息结构体，并且返回一个STRING（然后可以导出输出）

​    3.2  向服务器发送消息，个人修改了部分信息

​    3.3  向服务器发送消息， 向某个账号添加发送了聊天消息

​    3.4  向服务器发送消息， 向某个账号发送了 文件

​    3.5  向服务器发送消息， 查询好友（使用ID/NAME）

​    3.6  向服务器发送消息， 添加/删除 某个好友

​    3.7  更新本地好友信息



## 软件流程设计

---

1.服务端开启，进行并行监听（设置最大连接数），接到一个消息，则分一个子进程处理6

2.客户端登陆，发送带有账号密码迦密包到服务器，进行校验

3.（子进程）服务器监听建立连接，与数据内容对比，校验失败，发送回报密码错误，断开connect;校验成功则发松成功回报和待推送消息队列，并持续接受来自该客户端消息

​        -3.1  资料修改类消息

​        -3.2  发送信息消息

​        -3.3  好友查找类消息

4.客户端收到回报之后，使用数据库USER信息，初始化用户类，并且接受待推送消息；分出子进程持续接受服务端消息；主进程循环判定连接是否断开，并且进行是否重连询问

客户端需要的回报内容：

a.连接是否成功，用户名，签名，好友列表，待推送消息



3. 

### 操作日志和错误日治

---

以文件形式存在/log 下，每次执行某个函数之后，先向本地操作文本写入内容：

时间  函数 ID  SOCKET

2019-11-16_23:30    acpent()     293234    201



错误日志类似



 

